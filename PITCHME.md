### sortコマンドのマルチコア対応状況について調べてみた
itosue

---

コマンドの実行速度が結構バラバラで色んなやり方で試している人達が居る
* [‪データの集計ではsort | uniq -c をシェル芸で良く使うけど大量データには向かないのでawkでもっと高速な処理を書く](http://qiita.com/kazinoue/items/e7b98512186bace00097)
* [大きなテキストファイルをawkで処理するときにcatで投げ込むと速い理由](http://d.hatena.ne.jp/yohei-a/20150728/1438099752)
* [高速に並列処理: xargs -P vs parallel -j vs split -n r/](http://d.hatena.ne.jp/ichii386/20150627/1435357368)

---

メニーコア化が進んでいる中、UNIXの標準コマンドはどうなってるのか?
中でもシェル芸や実務で使用頻度が高いと思われるsortについて取り上げてみようと思います。

---

コマンド | オプション無し | --parallel=N(最大コア数) | --parallel=1
---------------- | ----------------- | ----------------- | -----------------
sort@mac | 49.846s | オプション存在せず | オプション存在せず
gsort@mac | 33.772s | 34.223s(4) | 46.422s
sort@Azure1 | 29.213s | 29.093s(8) | 1m12.125s
sort@Azure2 | 29.255s | 28.413s(8) | 1m10.404s
- 一番速いのはなぜかAzure上での４コア実行だった 0m25.857s (実行時間無指定比約11.5%減) |
- Azure2（sort 8.27)の環境でも25.414sと8.22とほぼ同じだった |
- Turbo Boostが効いてかつそれなりの並列数だと速くなるから？（推測） |

+++

### 実行環境
コマンド | バージョン | CPU （カッコ内はTB使用時最大クロック）| 備考
---------------- | ----------------- | ----------------- | -----------------
sort@mac | 5.93(2005) | Core i5 2.4GHz(2.9GHz) 2C4T | MBP late2013に最初から入ってるやつ
gsort@mac | 8.27(2017) | 同上 | brew install coreutilsで入ったやつ
sort@Azure1 | 8.22(2013) | Xeon E5-2660 2.20GHz(3GHz) 8C8T | CentOS 7.3に最初から入ってるやつ (VMのサイズはmacのCPUに特性が近いと思われるA8v2を選択。イメージはRogue Wave Softwareのものを使用)
sort@Azure2 | 8.27(2017) | Xeon E5-2660 2.20GHz(3GHz) 8C8T | ソースからビルド

+++
### parallelオプションに指定する値による違い全結果(sort@Azure1)
各評価前にsync&キャッシュのクリアを実行しています

parallelオプションの指定数 | real | user | sys
---------------- | ----------------- | ----------------- | -----------------
指定なし | 0m29.213s | 1m19.394s | 0m6.939s
8　 | 0m29.093s | 1m18.474s | 0m7.179s
7 | 0m34.568s | 1m17.627s | 0m6.487s
6 | 0m34.659s | 1m15.957s | 0m6.349s
5 | 0m34.826s | 1m15.393s | 0m5.900s
4 | 0m25.857s | 1m6.435s | 0m5.174s
3 | 0m39.054s | 1m6.009s | 0m4.153s
2 | 0m38.560s | 1m4.328s | 0m3.362s
1 | 1m12.125s | 1m8.997s | 0m3.100s

---

### 結論
* そのままでもいい感じに分散処理してくれている。
* 使うコア数が多ければ良いというものではない。
* 手元環境の特性を知っておくと作業効率UP!
* 標準ツール結構進化してる! 　参考：[RHL7/CentOS7の時代なのでcoreutils 8.22まで追いかけてみた](http://qiita.com/ma2saka/items/4099443efc2b93fe8fcd)
